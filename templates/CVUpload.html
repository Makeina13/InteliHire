<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload CV - InteliHire</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="upload-page">
    <nav class="navbar">
        <div class="nav-logo">
            <a href="{{ url_for('index') }}">InteliHire</a>
        </div>
        <ul class="nav-links">
            <li><a href="{{ url_for('index') }}">Home</a></li>
            <li><a href="{{ url_for('upload_cv') }}">Upload CV</a></li>
        </ul>
        <a href="{{ url_for('upload_cv') }}" class="nav-cta">Get started</a>
    </nav>


    <div class="container">
        <header>
            <h1>CV Remake Tool</h1>
            <p class="tagline">Powered by InteliHire</p>
        </header>

        <div class="upload-section">
            <form action="{{ url_for('analyze') }}" method="POST" enctype="multipart/form-data" id="analyzeForm">
                
                <div class="form-group">
                    <label>Upload Current CV</label>
                    <span class="file-name" id="cv-file-name">No file chosen</span>
                    
                    <label class="upload_cv">
                        <input type="file" id="cv-upload" name="cv" accept=".pdf,.docx" required>
                        <span class="icon">üìÅ</span>
                        <span id="cv-file-name">Choose a file...</span>
                    </label>
                </div>

                <div class="form-group">
                    <label>Target Job Description</label>
                    <textarea id="job-description" name="job_description" rows="6" required placeholder="Paste the job description..."></textarea>
                </div>

                <div class="form-group">
                    <label>Job Link (Optional)</label>
                    <input type="url" name="job_link" placeholder="Paste job link here" style="width: 100%; padding: 10px; border: 1px solid #334155; background: #0f172a; color: white; border-radius: 6px;">
                </div>

                <button type="submit" class="submit-btn" id="submit-btn">Generate PDF</button>
            </form>
        </div>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Processing with Gemini 2.0...</p>
        </div>
    </div>

    <script>
        // Fix: Ensure this runs after DOM is loaded
        const fileInput = document.getElementById('cv-upload');
        const fileNameDisplay = document.getElementById('cv-file-name');

        if(fileInput){
            fileInput.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    fileNameDisplay.textContent = this.files[0].name;
                } else {
                    fileNameDisplay.textContent = "Choose a file...";
                }
            });
        }

        const analyzeForm = document.getElementById('analyzeForm');
        if(analyzeForm){
            analyzeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const loading = document.getElementById('loading');
                const formDiv = document.querySelector('.upload-section');
                
                formDiv.style.display = 'none';
                loading.style.display = 'flex';

                const formData = new FormData(this);
                
                try {
                    const response = await fetch('/analyze', { // Use relative path safe for Flask
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        // FIX: Absolute redirection to prevent 404
                        window.location.href = window.location.origin + "/results?pdf=" + encodeURIComponent(data.pdf_url);
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                        formDiv.style.display = 'block';
                        loading.style.display = 'none';
                    }
                } catch (error) {
                    console.error(error);
                    alert('Connection Error');
                    formDiv.style.display = 'block';
                    loading.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>